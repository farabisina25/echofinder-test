

services:
  # The EchoFinder Node.js Application
  app:
    build: .
    container_name: echofinder-bot
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgres://echouser:echopass@db:5432/echofinder_db
      - NODE_ENV=production
      # Connect to the python container by its service name
      - EMBEDDING_SERVER=http://embedding-service:8001
      - WEBHOOK_PROXY_URL=${WEBHOOK_PROXY_URL}
      - APP_ID=${APP_ID}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PRIVATE_KEY_PATH=/private-key.pem 
    volumes:
      - ./private-key.pem:/private-key.pem:ro
    depends_on:
      db:
        condition: service_started
      embedding-service:
        condition: service_healthy

  # Python Embedding Service
  embedding-service:
    build:
      context: .
      dockerfile: Dockerfile.python
    container_name: echofinder-embedding
    restart: unless-stopped
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # PostgreSQL Database with pgvector extension
  db:
    image: pgvector/pgvector:pg16
    container_name: echofinder-postgres2
    restart: always
    environment:
      POSTGRES_USER: echouser
      POSTGRES_PASSWORD: echopass
      POSTGRES_DB: echofinder_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./create_issues_table:/docker-entrypoint-initdb.d/init.sql

volumes:
  postgres_data:
